name: terraform-ci

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

permissions:
  id-token: write   # 关键：允许工作流通过 OIDC 换取临时凭证
  contents: read

env:
  TF_INPUT: "false"
  TF_IN_AUTOMATION: "1"
  AWS_REGION: us-east-1

jobs:
  pr_plan:
    name: PR fmt/validate/plan (OIDC)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.12.2   # 与你本地一致，避免版本差异

      - name: Configure AWS via OIDC (plan)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::160885250897:role/gha-oidc-tf-plan
          aws-region: us-east-1

      - name: Terraform fmt & validate (no backend)
        run: |
          terraform fmt -check -recursive
          terraform init -backend-config=backend.hcl
          terraform validate

      - name: Terraform plan (dev, no lock)
        run: |
          terraform plan -lock=false -var-file=envs/dev.tfvars -detailed-exitcode -no-color
          exit_code=$?
          if [ $exit_code -eq 1 ]; then
            exit 1 #real error
          else
            exit 0 #no changes or success
          fi
          
  main_pipeline:
    name: Main init + plan (OIDC)
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.12.2

      - name: Configure AWS via OIDC (apply)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::160885250897:role/gha-oidc-tf-apply
          aws-region: us-east-1

      - name: Terraform init (backend)
        run: terraform init -backend-config=backend.hcl

      - name: Terraform plan (dev)
        run: terraform plan -var-file=envs/dev.tfvars

    # 稳定后解开自动部署（可选）
    # - name: Terraform apply (dev)
    # run: terraform apply -auto-approve -var-file=envs/dev.tfvars 
